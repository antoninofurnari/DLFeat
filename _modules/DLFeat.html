

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DLFeat &mdash; DLFeat 0.3.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />

  
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=4621528c"></script>
      <script src="../_static/doctools.js?v=9bcbadda"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            DLFeat
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../getting_started.html">Getting Started with DLFeat</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_started.html#installation">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_started.html#basic-usage">Basic Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../model_zoo.html">Model Zoo</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">DLFeat</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Module code</a></li>
      <li class="breadcrumb-item active">DLFeat</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for DLFeat</h1><div class="highlight"><pre>
<span></span><span class="c1"># DLFeat: Deep Learning Feature Extraction Library</span>
<span class="c1"># Inspired by VLFeat for ease of use and modularity in the modern deep learning era.</span>
<span class="c1"># Version: 0.5.0</span>
<span class="c1"># Author: Antonino Furnari</span>
<span class="c1"># Date: 2025-06-01</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">DLFeat: Deep Learning Feature Extraction Library</span>
<span class="sd">================================================</span>

<span class="sd">**DLFeat** is a Python library designed for easy and modular feature extraction </span>
<span class="sd">from various data modalities including images, videos, audio, and text. </span>
<span class="sd">It leverages powerful pre-trained models from libraries like PyTorch, torchvision, </span>
<span class="sd">Transformers, Sentence-Transformers, and TIMM. </span>
<span class="sd">The goal is to provide a &quot;black box&quot; tool suitable for educational and research purposes, </span>
<span class="sd">allowing users to quickly extract meaningful features for data analysis tasks </span>
<span class="sd">without needing to delve into the complexities of each model&#39;s architecture or training.</span>

<span class="sd">This library is compatible with the scikit-learn transformer API and includes a </span>
<span class="sd">callable self-test function (`run_self_tests()`) to verify model availability </span>
<span class="sd">and basic functionality in your environment.</span>

<span class="sd">Core Features</span>
<span class="sd">-------------</span>
<span class="sd">- **Unified API**: Consistent `DLFeatExtractor` class for all modalities.</span>
<span class="sd">- **Scikit-learn Compatible**: Implements `BaseEstimator` and `TransformerMixin`.</span>
<span class="sd">- **Multi-Modal Support**: Features from images, videos, audio, and text.</span>
<span class="sd">- **Extensive Model Zoo**: Access to a wide range of pre-trained models.</span>
<span class="sd">- **Automatic Handling**: Manages model loading, preprocessing, and device placement.</span>
<span class="sd">- **Single-File Library**: Easy to integrate (dependencies must be installed).</span>

<span class="sd">For detailed installation instructions, a &quot;Getting Started&quot; guide with code examples,</span>
<span class="sd">the complete Model Zoo, and API reference, please refer to the full documentation.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="n">__version__</span> <span class="o">=</span> <span class="s2">&quot;0.5.0&quot;</span> 

<span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torchvision</span> 
<span class="kn">import</span><span class="w"> </span><span class="nn">torchvision.transforms</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">T</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torchvision.models</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">tv_models</span> 
<span class="kn">import</span><span class="w"> </span><span class="nn">torchvision.models.video</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">tv_video_models</span> 
<span class="kn">from</span><span class="w"> </span><span class="nn">PIL</span><span class="w"> </span><span class="kn">import</span> <span class="n">Image</span><span class="p">,</span> <span class="n">ImageDraw</span> 
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">textwrap</span> 
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span> 
<span class="kn">import</span><span class="w"> </span><span class="nn">traceback</span> <span class="c1"># For printing full tracebacks in tests</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
        <span class="s2">&quot;The &#39;requests&#39; library is not installed. &quot;</span>
        <span class="s2">&quot;DLFeat self-tests will use a placeholder for video models instead of downloading a real sample. &quot;</span>
        <span class="s2">&quot;To enable real video testing, please install it: pip install requests&quot;</span>
    <span class="p">)</span>
    <span class="k">class</span><span class="w"> </span><span class="nc">requests</span><span class="p">:</span> 
        <span class="nd">@staticmethod</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s2">&quot;requests library is not installed.&quot;</span><span class="p">)</span>
        <span class="k">class</span><span class="w"> </span><span class="nc">exceptions</span><span class="p">:</span> 
            <span class="k">class</span><span class="w"> </span><span class="nc">RequestException</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span> <span class="k">pass</span>


<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseEstimator</span><span class="p">,</span> <span class="n">TransformerMixin</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
        <span class="s2">&quot;scikit-learn not found. DLFeatExtractor will not be scikit-learn compatible. &quot;</span>
        <span class="s2">&quot;Please install it: pip install scikit-learn&quot;</span>
    <span class="p">)</span>
    <span class="k">class</span><span class="w"> </span><span class="nc">BaseEstimator</span><span class="p">:</span> <span class="k">pass</span>
    <span class="k">class</span><span class="w"> </span><span class="nc">TransformerMixin</span><span class="p">:</span> <span class="k">pass</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">transformers</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
        <span class="n">AutoProcessor</span><span class="p">,</span> <span class="n">AutoModel</span><span class="p">,</span> <span class="n">AutoTokenizer</span><span class="p">,</span> <span class="n">Wav2Vec2FeatureExtractor</span><span class="p">,</span>
        <span class="n">AutoImageProcessor</span><span class="p">,</span> 
        <span class="n">CLIPProcessor</span><span class="p">,</span> <span class="n">CLIPModel</span><span class="p">,</span> <span class="n">BlipProcessor</span><span class="p">,</span> <span class="n">BlipModel</span><span class="p">,</span> <span class="c1"># Kept Blip for potential future re-add</span>
        <span class="n">VideoMAEImageProcessor</span><span class="p">,</span> <span class="n">VideoMAEModel</span><span class="p">,</span> 
        <span class="n">XCLIPProcessor</span><span class="p">,</span> <span class="n">XCLIPModel</span><span class="p">,</span>
        <span class="n">ASTFeatureExtractor</span><span class="p">,</span>
        <span class="n">Dinov2Model</span>
    <span class="p">)</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
        <span class="s2">&quot;Transformers library not found or key components are missing. &quot;</span>
        <span class="s2">&quot;Text, some audio, DINOv2, VideoMAE and multimodal models may not be available. &quot;</span>
        <span class="s2">&quot;Please install or upgrade transformers: pip install --upgrade transformers&quot;</span>
    <span class="p">)</span>
    <span class="k">class</span><span class="w"> </span><span class="nc">AutoProcessor</span><span class="p">:</span> <span class="k">pass</span>
    <span class="k">class</span><span class="w"> </span><span class="nc">AutoModel</span><span class="p">:</span> <span class="k">pass</span>
    <span class="k">class</span><span class="w"> </span><span class="nc">AutoTokenizer</span><span class="p">:</span> <span class="k">pass</span>
    <span class="k">class</span><span class="w"> </span><span class="nc">Wav2Vec2FeatureExtractor</span><span class="p">:</span> <span class="k">pass</span>
    <span class="k">class</span><span class="w"> </span><span class="nc">AutoImageProcessor</span><span class="p">:</span> <span class="k">pass</span>
    <span class="k">class</span><span class="w"> </span><span class="nc">CLIPProcessor</span><span class="p">:</span> <span class="k">pass</span>
    <span class="k">class</span><span class="w"> </span><span class="nc">CLIPModel</span><span class="p">:</span> <span class="k">pass</span>
    <span class="k">class</span><span class="w"> </span><span class="nc">BlipProcessor</span><span class="p">:</span> <span class="k">pass</span> 
    <span class="k">class</span><span class="w"> </span><span class="nc">BlipModel</span><span class="p">:</span> <span class="k">pass</span>   
    <span class="k">class</span><span class="w"> </span><span class="nc">VideoMAEImageProcessor</span><span class="p">:</span> <span class="k">pass</span> 
    <span class="k">class</span><span class="w"> </span><span class="nc">VideoMAEModel</span><span class="p">:</span> <span class="k">pass</span>
    <span class="k">class</span><span class="w"> </span><span class="nc">XCLIPProcessor</span><span class="p">:</span> <span class="k">pass</span>
    <span class="k">class</span><span class="w"> </span><span class="nc">XCLIPModel</span><span class="p">:</span> <span class="k">pass</span>
    <span class="k">class</span><span class="w"> </span><span class="nc">ASTFeatureExtractor</span><span class="p">:</span> <span class="k">pass</span>
    <span class="k">class</span><span class="w"> </span><span class="nc">Dinov2Model</span><span class="p">:</span> <span class="k">pass</span>


<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">sentence_transformers</span><span class="w"> </span><span class="kn">import</span> <span class="n">SentenceTransformer</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
        <span class="s2">&quot;Sentence-Transformers library not found. `sentence-bert` model will not be available. &quot;</span>
        <span class="s2">&quot;Please install it: pip install sentence-transformers&quot;</span>
    <span class="p">)</span>
    <span class="k">class</span><span class="w"> </span><span class="nc">SentenceTransformer</span><span class="p">:</span> <span class="k">pass</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">timm</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
        <span class="s2">&quot;TIMM library not found. Some image models (ViT, EfficientNet, ConvNeXt) will not be available. &quot;</span> 
        <span class="s2">&quot;Please install it: pip install timm&quot;</span>
    <span class="p">)</span>
    <span class="k">class</span><span class="w"> </span><span class="nc">timm</span><span class="p">:</span>
        <span class="nd">@staticmethod</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">create_model</span><span class="p">(</span><span class="n">model_name</span><span class="p">,</span> <span class="n">pretrained</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">num_classes</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s2">&quot;TIMM library is not installed.&quot;</span><span class="p">)</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">torchaudio</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">torchaudio.transforms</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">TA</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">scipy.io.wavfile</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">scipy_wav</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
        <span class="s2">&quot;Torchaudio or Scipy library not found. Audio processing or self-tests for audio might be limited. &quot;</span>
        <span class="s2">&quot;Please install them: pip install torchaudio scipy&quot;</span>
    <span class="p">)</span>
    <span class="k">class</span><span class="w"> </span><span class="nc">torchaudio</span><span class="p">:</span> <span class="k">pass</span> 
    <span class="k">class</span><span class="w"> </span><span class="nc">TA</span><span class="p">:</span> <span class="k">pass</span> 
    <span class="k">class</span><span class="w"> </span><span class="nc">scipy_wav</span><span class="p">:</span> 
        <span class="nd">@staticmethod</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">write</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span> <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s2">&quot;Scipy not installed, cannot write dummy audio.&quot;</span><span class="p">)</span>

<span class="c1"># PyTorchVideo related imports and mocks are removed as it&#39;s no longer a direct dependency for listed models.</span>

<span class="n">MODEL_CONFIGS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="c1"># --- Image Models ---</span>
    <span class="s2">&quot;resnet18&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;task&quot;</span><span class="p">:</span> <span class="s2">&quot;image&quot;</span><span class="p">,</span> <span class="s2">&quot;dim&quot;</span><span class="p">:</span> <span class="mi">512</span><span class="p">,</span> <span class="s2">&quot;input_size&quot;</span><span class="p">:</span> <span class="mi">224</span><span class="p">,</span> <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="s2">&quot;torchvision&quot;</span><span class="p">},</span>
    <span class="s2">&quot;resnet34&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;task&quot;</span><span class="p">:</span> <span class="s2">&quot;image&quot;</span><span class="p">,</span> <span class="s2">&quot;dim&quot;</span><span class="p">:</span> <span class="mi">512</span><span class="p">,</span> <span class="s2">&quot;input_size&quot;</span><span class="p">:</span> <span class="mi">224</span><span class="p">,</span> <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="s2">&quot;torchvision&quot;</span><span class="p">},</span>
    <span class="s2">&quot;resnet50&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;task&quot;</span><span class="p">:</span> <span class="s2">&quot;image&quot;</span><span class="p">,</span> <span class="s2">&quot;dim&quot;</span><span class="p">:</span> <span class="mi">2048</span><span class="p">,</span> <span class="s2">&quot;input_size&quot;</span><span class="p">:</span> <span class="mi">224</span><span class="p">,</span> <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="s2">&quot;torchvision_or_timm&quot;</span><span class="p">},</span>
    <span class="s2">&quot;resnet101&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;task&quot;</span><span class="p">:</span> <span class="s2">&quot;image&quot;</span><span class="p">,</span> <span class="s2">&quot;dim&quot;</span><span class="p">:</span> <span class="mi">2048</span><span class="p">,</span> <span class="s2">&quot;input_size&quot;</span><span class="p">:</span> <span class="mi">224</span><span class="p">,</span> <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="s2">&quot;torchvision_or_timm&quot;</span><span class="p">},</span>
    <span class="s2">&quot;resnet152&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;task&quot;</span><span class="p">:</span> <span class="s2">&quot;image&quot;</span><span class="p">,</span> <span class="s2">&quot;dim&quot;</span><span class="p">:</span> <span class="mi">2048</span><span class="p">,</span> <span class="s2">&quot;input_size&quot;</span><span class="p">:</span> <span class="mi">224</span><span class="p">,</span> <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="s2">&quot;torchvision_or_timm&quot;</span><span class="p">},</span>
    <span class="s2">&quot;efficientnet_b0&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;task&quot;</span><span class="p">:</span> <span class="s2">&quot;image&quot;</span><span class="p">,</span> <span class="s2">&quot;dim&quot;</span><span class="p">:</span> <span class="mi">1280</span><span class="p">,</span> <span class="s2">&quot;input_size&quot;</span><span class="p">:</span> <span class="mi">224</span><span class="p">,</span> <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="s2">&quot;timm&quot;</span><span class="p">,</span> <span class="s2">&quot;timm_name&quot;</span><span class="p">:</span> <span class="s2">&quot;efficientnet_b0&quot;</span><span class="p">},</span>
    <span class="s2">&quot;efficientnet_b2&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;task&quot;</span><span class="p">:</span> <span class="s2">&quot;image&quot;</span><span class="p">,</span> <span class="s2">&quot;dim&quot;</span><span class="p">:</span> <span class="mi">1408</span><span class="p">,</span> <span class="s2">&quot;input_size&quot;</span><span class="p">:</span> <span class="mi">260</span><span class="p">,</span> <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="s2">&quot;timm&quot;</span><span class="p">,</span> <span class="s2">&quot;timm_name&quot;</span><span class="p">:</span> <span class="s2">&quot;efficientnet_b2&quot;</span><span class="p">},</span>
    <span class="s2">&quot;efficientnet_b4&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;task&quot;</span><span class="p">:</span> <span class="s2">&quot;image&quot;</span><span class="p">,</span> <span class="s2">&quot;dim&quot;</span><span class="p">:</span> <span class="mi">1792</span><span class="p">,</span> <span class="s2">&quot;input_size&quot;</span><span class="p">:</span> <span class="mi">380</span><span class="p">,</span> <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="s2">&quot;timm&quot;</span><span class="p">,</span> <span class="s2">&quot;timm_name&quot;</span><span class="p">:</span> <span class="s2">&quot;efficientnet_b4&quot;</span><span class="p">},</span>
    <span class="s2">&quot;mobilenet_v2&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;task&quot;</span><span class="p">:</span> <span class="s2">&quot;image&quot;</span><span class="p">,</span> <span class="s2">&quot;dim&quot;</span><span class="p">:</span> <span class="mi">1280</span><span class="p">,</span> <span class="s2">&quot;input_size&quot;</span><span class="p">:</span> <span class="mi">224</span><span class="p">,</span> <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="s2">&quot;torchvision&quot;</span><span class="p">},</span>
    <span class="s2">&quot;mobilenet_v3_small&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;task&quot;</span><span class="p">:</span> <span class="s2">&quot;image&quot;</span><span class="p">,</span> <span class="s2">&quot;dim&quot;</span><span class="p">:</span> <span class="mi">576</span><span class="p">,</span> <span class="s2">&quot;input_size&quot;</span><span class="p">:</span> <span class="mi">224</span><span class="p">,</span> <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="s2">&quot;torchvision&quot;</span><span class="p">},</span> 
    <span class="s2">&quot;mobilenet_v3_large&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;task&quot;</span><span class="p">:</span> <span class="s2">&quot;image&quot;</span><span class="p">,</span> <span class="s2">&quot;dim&quot;</span><span class="p">:</span> <span class="mi">960</span><span class="p">,</span> <span class="s2">&quot;input_size&quot;</span><span class="p">:</span> <span class="mi">224</span><span class="p">,</span> <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="s2">&quot;torchvision&quot;</span><span class="p">},</span> 
    <span class="s2">&quot;vit_tiny_patch16_224&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;task&quot;</span><span class="p">:</span> <span class="s2">&quot;image&quot;</span><span class="p">,</span> <span class="s2">&quot;dim&quot;</span><span class="p">:</span> <span class="mi">192</span><span class="p">,</span> <span class="s2">&quot;input_size&quot;</span><span class="p">:</span> <span class="mi">224</span><span class="p">,</span> <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="s2">&quot;timm&quot;</span><span class="p">,</span> <span class="s2">&quot;timm_name&quot;</span><span class="p">:</span> <span class="s2">&quot;vit_tiny_patch16_224.augreg_in21k_ft_in1k&quot;</span><span class="p">},</span> 
    <span class="s2">&quot;vit_small_patch16_224&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;task&quot;</span><span class="p">:</span> <span class="s2">&quot;image&quot;</span><span class="p">,</span> <span class="s2">&quot;dim&quot;</span><span class="p">:</span> <span class="mi">384</span><span class="p">,</span> <span class="s2">&quot;input_size&quot;</span><span class="p">:</span> <span class="mi">224</span><span class="p">,</span> <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="s2">&quot;timm&quot;</span><span class="p">,</span> <span class="s2">&quot;timm_name&quot;</span><span class="p">:</span> <span class="s2">&quot;vit_small_patch16_224.augreg_in21k_ft_in1k&quot;</span><span class="p">},</span>
    <span class="s2">&quot;vit_base_patch16_224&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;task&quot;</span><span class="p">:</span> <span class="s2">&quot;image&quot;</span><span class="p">,</span> <span class="s2">&quot;dim&quot;</span><span class="p">:</span> <span class="mi">768</span><span class="p">,</span> <span class="s2">&quot;input_size&quot;</span><span class="p">:</span> <span class="mi">224</span><span class="p">,</span> <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="s2">&quot;timm&quot;</span><span class="p">,</span> <span class="s2">&quot;timm_name&quot;</span><span class="p">:</span> <span class="s2">&quot;vit_base_patch16_224.mae&quot;</span><span class="p">},</span> 
    <span class="s2">&quot;dinov2_base&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;task&quot;</span><span class="p">:</span> <span class="s2">&quot;image&quot;</span><span class="p">,</span> <span class="s2">&quot;dim&quot;</span><span class="p">:</span> <span class="mi">768</span><span class="p">,</span> <span class="s2">&quot;input_size&quot;</span><span class="p">:</span> <span class="mi">224</span><span class="p">,</span> <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="s2">&quot;transformers&quot;</span><span class="p">,</span> <span class="s2">&quot;hf_name&quot;</span><span class="p">:</span> <span class="s2">&quot;facebook/dinov2-base&quot;</span><span class="p">},</span>

    <span class="c1"># --- Video Models (Refactored - MViT and PTV models removed) ---</span>
    <span class="c1"># torchvision models</span>
    <span class="s2">&quot;r2plus1d_18&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;task&quot;</span><span class="p">:</span> <span class="s2">&quot;video&quot;</span><span class="p">,</span> <span class="s2">&quot;dim&quot;</span><span class="p">:</span> <span class="mi">512</span><span class="p">,</span> <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="s2">&quot;torchvision&quot;</span><span class="p">,</span> <span class="s2">&quot;tv_model_name&quot;</span><span class="p">:</span><span class="s2">&quot;r2plus1d_18&quot;</span><span class="p">,</span> <span class="s2">&quot;clip_len&quot;</span><span class="p">:</span> <span class="mi">16</span><span class="p">,</span> <span class="s2">&quot;frame_rate&quot;</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span> <span class="s2">&quot;input_size&quot;</span><span class="p">:</span> <span class="mi">112</span><span class="p">},</span> 
    <span class="s2">&quot;video_swin_t&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;task&quot;</span><span class="p">:</span> <span class="s2">&quot;video&quot;</span><span class="p">,</span> <span class="s2">&quot;dim&quot;</span><span class="p">:</span> <span class="mi">768</span><span class="p">,</span> <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="s2">&quot;torchvision&quot;</span><span class="p">,</span> <span class="s2">&quot;tv_model_name&quot;</span><span class="p">:</span> <span class="s2">&quot;swin3d_t&quot;</span><span class="p">,</span> <span class="s2">&quot;clip_len&quot;</span><span class="p">:</span> <span class="mi">32</span><span class="p">,</span> <span class="s2">&quot;input_size&quot;</span><span class="p">:</span> <span class="mi">224</span><span class="p">},</span> 
    <span class="s2">&quot;video_swin_s&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;task&quot;</span><span class="p">:</span> <span class="s2">&quot;video&quot;</span><span class="p">,</span> <span class="s2">&quot;dim&quot;</span><span class="p">:</span> <span class="mi">768</span><span class="p">,</span> <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="s2">&quot;torchvision&quot;</span><span class="p">,</span> <span class="s2">&quot;tv_model_name&quot;</span><span class="p">:</span> <span class="s2">&quot;swin3d_s&quot;</span><span class="p">,</span> <span class="s2">&quot;clip_len&quot;</span><span class="p">:</span> <span class="mi">32</span><span class="p">,</span> <span class="s2">&quot;input_size&quot;</span><span class="p">:</span> <span class="mi">224</span><span class="p">},</span> 
    <span class="s2">&quot;video_swin_b&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;task&quot;</span><span class="p">:</span> <span class="s2">&quot;video&quot;</span><span class="p">,</span> <span class="s2">&quot;dim&quot;</span><span class="p">:</span> <span class="mi">1024</span><span class="p">,</span> <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="s2">&quot;torchvision&quot;</span><span class="p">,</span> <span class="s2">&quot;tv_model_name&quot;</span><span class="p">:</span> <span class="s2">&quot;swin3d_b&quot;</span><span class="p">,</span> <span class="s2">&quot;clip_len&quot;</span><span class="p">:</span> <span class="mi">32</span><span class="p">,</span> <span class="s2">&quot;input_size&quot;</span><span class="p">:</span> <span class="mi">224</span><span class="p">},</span>
    
    <span class="c1"># transformers models</span>
    <span class="s2">&quot;videomae_base_k400_pt&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;task&quot;</span><span class="p">:</span> <span class="s2">&quot;video&quot;</span><span class="p">,</span> <span class="s2">&quot;dim&quot;</span><span class="p">:</span> <span class="mi">768</span><span class="p">,</span> <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="s2">&quot;transformers&quot;</span><span class="p">,</span> <span class="s2">&quot;hf_name&quot;</span><span class="p">:</span> <span class="s2">&quot;MCG-NJU/videomae-base-finetuned-kinetics&quot;</span><span class="p">,</span> <span class="s2">&quot;num_frames&quot;</span><span class="p">:</span> <span class="mi">16</span><span class="p">,</span> <span class="s2">&quot;input_size&quot;</span><span class="p">:</span> <span class="mi">224</span><span class="p">},</span>
    
    <span class="c1"># --- Audio Models ---</span>
    <span class="s2">&quot;wav2vec2_base&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;task&quot;</span><span class="p">:</span> <span class="s2">&quot;audio&quot;</span><span class="p">,</span> <span class="s2">&quot;dim&quot;</span><span class="p">:</span> <span class="mi">768</span><span class="p">,</span> <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="s2">&quot;transformers&quot;</span><span class="p">,</span> <span class="s2">&quot;hf_name&quot;</span><span class="p">:</span> <span class="s2">&quot;facebook/wav2vec2-base-960h&quot;</span><span class="p">,</span> <span class="s2">&quot;sampling_rate&quot;</span><span class="p">:</span> <span class="mi">16000</span><span class="p">},</span>
    <span class="s2">&quot;ast_vit_base_patch16_224&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;task&quot;</span><span class="p">:</span> <span class="s2">&quot;audio&quot;</span><span class="p">,</span> <span class="s2">&quot;dim&quot;</span><span class="p">:</span> <span class="mi">768</span><span class="p">,</span> <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="s2">&quot;transformers&quot;</span><span class="p">,</span> <span class="s2">&quot;hf_name&quot;</span><span class="p">:</span> <span class="s2">&quot;MIT/ast-finetuned-audioset-10-10-0.4593&quot;</span><span class="p">,</span> <span class="s2">&quot;sampling_rate&quot;</span><span class="p">:</span> <span class="mi">16000</span><span class="p">,</span> <span class="s2">&quot;num_mel_bins&quot;</span><span class="p">:</span> <span class="mi">128</span><span class="p">,</span> <span class="s2">&quot;max_length_s&quot;</span><span class="p">:</span> <span class="mf">10.24</span><span class="p">},</span>

    <span class="c1"># --- Text Models ---</span>
    <span class="s2">&quot;sentence-bert&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;task&quot;</span><span class="p">:</span> <span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="s2">&quot;dim&quot;</span><span class="p">:</span> <span class="mi">384</span><span class="p">,</span> <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="s2">&quot;sentence-transformers&quot;</span><span class="p">,</span> <span class="s2">&quot;st_name&quot;</span><span class="p">:</span> <span class="s2">&quot;all-MiniLM-L6-v2&quot;</span><span class="p">},</span>
    <span class="s2">&quot;bert_base_uncased&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;task&quot;</span><span class="p">:</span> <span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="s2">&quot;dim&quot;</span><span class="p">:</span> <span class="mi">768</span><span class="p">,</span> <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="s2">&quot;transformers&quot;</span><span class="p">,</span> <span class="s2">&quot;hf_name&quot;</span><span class="p">:</span> <span class="s2">&quot;bert-base-uncased&quot;</span><span class="p">},</span>

    <span class="c1"># --- Multimodal Models ---</span>
    <span class="s2">&quot;clip_vit_b32&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;task&quot;</span><span class="p">:</span> <span class="s2">&quot;multimodal_image_text&quot;</span><span class="p">,</span> <span class="s2">&quot;dim&quot;</span><span class="p">:</span> <span class="mi">512</span><span class="p">,</span> <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="s2">&quot;transformers&quot;</span><span class="p">,</span> <span class="s2">&quot;hf_name&quot;</span><span class="p">:</span> <span class="s2">&quot;openai/clip-vit-base-patch32&quot;</span><span class="p">},</span>
    <span class="s2">&quot;xclip_base_patch16&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;task&quot;</span><span class="p">:</span> <span class="s2">&quot;multimodal_video_text&quot;</span><span class="p">,</span> <span class="s2">&quot;dim&quot;</span><span class="p">:</span> <span class="mi">512</span><span class="p">,</span> <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="s2">&quot;transformers&quot;</span><span class="p">,</span> <span class="s2">&quot;hf_name&quot;</span><span class="p">:</span> <span class="s2">&quot;microsoft/xclip-base-patch16&quot;</span><span class="p">,</span> <span class="s2">&quot;num_frames&quot;</span><span class="p">:</span> <span class="mi">8</span><span class="p">}</span>
<span class="p">}</span>

<span class="n">DEFAULT_MODELS_TO_TEST</span> <span class="o">=</span> <span class="p">[</span> 
    <span class="s2">&quot;resnet18&quot;</span><span class="p">,</span> <span class="s2">&quot;efficientnet_b0&quot;</span><span class="p">,</span> <span class="s2">&quot;mobilenet_v2&quot;</span><span class="p">,</span> <span class="s2">&quot;vit_tiny_patch16_224&quot;</span><span class="p">,</span> <span class="s2">&quot;dinov2_base&quot;</span><span class="p">,</span>
    <span class="s2">&quot;r2plus1d_18&quot;</span><span class="p">,</span> <span class="s2">&quot;videomae_base_k400_pt&quot;</span><span class="p">,</span> <span class="s2">&quot;video_swin_t&quot;</span><span class="p">,</span>
    <span class="s2">&quot;wav2vec2_base&quot;</span><span class="p">,</span> <span class="s2">&quot;sentence-bert&quot;</span><span class="p">,</span> 
    <span class="s2">&quot;clip_vit_b32&quot;</span><span class="p">,</span> <span class="s2">&quot;xclip_base_patch16&quot;</span>
<span class="p">]</span>


<div class="viewcode-block" id="list_available_models">
<a class="viewcode-back" href="../index.html#DLFeat.list_available_models">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">list_available_models</span><span class="p">(</span><span class="n">task_type</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">task_type</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">name</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">config</span> <span class="ow">in</span> <span class="n">MODEL_CONFIGS</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;task&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">task_type</span><span class="p">]</span>
    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">MODEL_CONFIGS</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span></div>


<div class="viewcode-block" id="DLFeatExtractor">
<a class="viewcode-back" href="../index.html#DLFeat.DLFeatExtractor">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">DLFeatExtractor</span><span class="p">(</span><span class="n">BaseEstimator</span><span class="p">,</span> <span class="n">TransformerMixin</span><span class="p">):</span>
<div class="viewcode-block" id="DLFeatExtractor.__init__">
<a class="viewcode-back" href="../index.html#DLFeat.DLFeatExtractor.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">task_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">model_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">MODEL_CONFIGS</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Model &#39;</span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">&#39; not found. &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Available models: </span><span class="si">{</span><span class="n">list_available_models</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model_name</span> <span class="o">=</span> <span class="n">model_name</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">MODEL_CONFIGS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">model_name</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">task_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;task&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">task_type</span> <span class="ow">and</span> <span class="n">task_type</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">task_type</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Provided task_type &#39;</span><span class="si">{</span><span class="n">task_type</span><span class="si">}</span><span class="s2">&#39; does not match model &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model_name</span><span class="si">}</span><span class="s2">&#39;s task &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">task_type</span><span class="si">}</span><span class="s2">&#39;.&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">device</span> <span class="o">==</span> <span class="s2">&quot;auto&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cuda&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">backends</span><span class="p">,</span> <span class="s1">&#39;mps&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">torch</span><span class="o">.</span><span class="n">backends</span><span class="o">.</span><span class="n">mps</span><span class="o">.</span><span class="n">is_available</span><span class="p">():</span> 
                <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;mps&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">processor</span> <span class="o">=</span> <span class="kc">None</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="kc">None</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">image_transform</span> <span class="o">=</span> <span class="kc">None</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">audio_resampler</span> <span class="o">=</span> <span class="kc">None</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">video_frame_transform</span> <span class="o">=</span> <span class="kc">None</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">target_sr</span> <span class="o">=</span> <span class="kc">None</span> 

        <span class="bp">self</span><span class="o">.</span><span class="n">_load_model</span><span class="p">()</span></div>


<div class="viewcode-block" id="DLFeatExtractor.get_feature_dimension">
<a class="viewcode-back" href="../index.html#DLFeat.DLFeatExtractor.get_feature_dimension">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_feature_dimension</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;dim&quot;</span><span class="p">]</span></div>


<div class="viewcode-block" id="DLFeatExtractor.get_model_config">
<a class="viewcode-back" href="../index.html#DLFeat.DLFeatExtractor.get_model_config">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_model_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span></div>

    
    <span class="k">def</span><span class="w"> </span><span class="nf">_load_image_model_torchvision</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_name_tv</span><span class="p">):</span>
        <span class="n">model_fn</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">tv_models</span><span class="p">,</span> <span class="n">model_name_tv</span><span class="p">)</span>
        
        <span class="n">weights_enum_name_to_try</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">model_name_tv</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;resnet&quot;</span><span class="p">):</span>
            <span class="n">name_part</span> <span class="o">=</span> <span class="n">model_name_tv</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="s2">&quot;resnet&quot;</span><span class="p">):]</span> 
            <span class="n">weights_enum_name_to_try</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;ResNet</span><span class="si">{</span><span class="n">name_part</span><span class="si">}</span><span class="s2">_Weights&quot;</span> 
        <span class="k">elif</span> <span class="n">model_name_tv</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;vgg&quot;</span><span class="p">):</span> 
            <span class="n">weights_enum_name_to_try</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">model_name_tv</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2">_Weights&quot;</span>
        <span class="k">elif</span> <span class="n">model_name_tv</span> <span class="o">==</span> <span class="s2">&quot;mobilenet_v2&quot;</span><span class="p">:</span> 
             <span class="n">weights_enum_name_to_try</span> <span class="o">=</span> <span class="s2">&quot;MobileNet_V2_Weights&quot;</span>
        <span class="k">elif</span> <span class="n">model_name_tv</span> <span class="o">==</span> <span class="s2">&quot;mobilenet_v3_large&quot;</span><span class="p">:</span> 
             <span class="n">weights_enum_name_to_try</span> <span class="o">=</span> <span class="s2">&quot;MobileNet_V3_Large_Weights&quot;</span>
        <span class="k">elif</span> <span class="n">model_name_tv</span> <span class="o">==</span> <span class="s2">&quot;mobilenet_v3_small&quot;</span><span class="p">:</span> 
             <span class="n">weights_enum_name_to_try</span> <span class="o">=</span> <span class="s2">&quot;MobileNet_V3_Small_Weights&quot;</span>
        <span class="k">elif</span> <span class="n">model_name_tv</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;efficientnet_b&quot;</span><span class="p">):</span> 
            <span class="n">name_part</span> <span class="o">=</span> <span class="n">model_name_tv</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="s2">&quot;efficientnet_&quot;</span><span class="p">):]</span> 
            <span class="n">weights_enum_name_to_try</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;EfficientNet_</span><span class="si">{</span><span class="n">name_part</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2">_Weights&quot;</span> 
        <span class="k">elif</span> <span class="n">model_name_tv</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;convnext_&quot;</span><span class="p">):</span> 
            <span class="n">name_part</span> <span class="o">=</span> <span class="n">model_name_tv</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="s2">&quot;convnext_&quot;</span><span class="p">):]</span> 
            <span class="n">weights_enum_name_to_try</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;ConvNeXt_</span><span class="si">{</span><span class="n">name_part</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span><span class="si">}</span><span class="s2">_Weights&quot;</span> 
        <span class="k">else</span><span class="p">:</span>
            <span class="n">weights_enum_name_to_try</span> <span class="o">=</span> <span class="n">model_name_tv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">+</span> <span class="n">model_name_tv</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="s2">&quot;_Weights&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">weights_class</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">tv_models</span><span class="p">,</span> <span class="n">weights_enum_name_to_try</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">weights_class</span><span class="p">,</span> <span class="s1">&#39;DEFAULT&#39;</span><span class="p">):</span>
                <span class="n">weights_obj</span> <span class="o">=</span> <span class="n">weights_class</span><span class="o">.</span><span class="n">DEFAULT</span>
            <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">weights_class</span><span class="p">,</span> <span class="s1">&#39;IMAGENET1K_V1&#39;</span><span class="p">):</span> 
                <span class="n">weights_obj</span> <span class="o">=</span> <span class="n">weights_class</span><span class="o">.</span><span class="n">IMAGENET1K_V1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">available_enum_members</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">weights_class</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">m</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">m</span><span class="o">.</span><span class="n">isupper</span><span class="p">()]</span>
                <span class="k">if</span> <span class="n">available_enum_members</span><span class="p">:</span>
                    <span class="n">first_available_weight_name</span> <span class="o">=</span> <span class="n">available_enum_members</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">weights_obj</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">weights_class</span><span class="p">,</span> <span class="n">first_available_weight_name</span><span class="p">)</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;DLFeatExtractor: Using first available weight &#39;</span><span class="si">{</span><span class="n">first_available_weight_name</span><span class="si">}</span><span class="s2">&#39; for </span><span class="si">{</span><span class="n">model_name_tv</span><span class="si">}</span><span class="s2"> as DEFAULT/IMAGENET1K_V1 not found in its enum.&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No DEFAULT, IMAGENET1K_V1, or other suitable weights found in </span><span class="si">{</span><span class="n">weights_enum_name_to_try</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model_fn</span><span class="p">(</span><span class="n">weights</span><span class="o">=</span><span class="n">weights_obj</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">weights_obj</span><span class="p">,</span> <span class="s1">&#39;transforms&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">callable</span><span class="p">(</span><span class="n">weights_obj</span><span class="o">.</span><span class="n">transforms</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">image_transform</span> <span class="o">=</span> <span class="n">weights_obj</span><span class="o">.</span><span class="n">transforms</span><span class="p">()</span>

        <span class="k">except</span> <span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e_new_api_img</span><span class="p">:</span> 
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;DLFeatExtractor: Failed to use new &#39;weights&#39; API for image model </span><span class="si">{</span><span class="n">model_name_tv</span><span class="si">}</span><span class="s2"> (Error: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">e_new_api_img</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e_new_api_img</span><span class="si">}</span><span class="s2">). &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Falling back to legacy &#39;pretrained=True&#39;. Torchvision warnings may follow.&quot;</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model_fn</span><span class="p">(</span><span class="n">pretrained</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">model_name_tv</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;mobilenet_v3&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">classifier</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Identity</span><span class="p">()</span> 
        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;classifier&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">classifier</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">classifier</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">:</span>
             <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">classifier</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Identity</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;fc&#39;</span><span class="p">):</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">fc</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Identity</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;classifier&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">classifier</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">):</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">classifier</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Identity</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_transform</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">input_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;input_size&quot;</span><span class="p">,</span> <span class="mi">224</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">image_transform</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">Compose</span><span class="p">([</span>
                <span class="n">T</span><span class="o">.</span><span class="n">Resize</span><span class="p">(</span><span class="mi">256</span> <span class="k">if</span> <span class="n">input_size</span> <span class="o">==</span> <span class="mi">224</span> <span class="k">else</span> <span class="nb">int</span><span class="p">(</span><span class="n">input_size</span> <span class="o">/</span> <span class="p">(</span><span class="mf">224.0</span><span class="o">/</span><span class="mf">256.0</span><span class="p">))),</span> 
                <span class="n">T</span><span class="o">.</span><span class="n">CenterCrop</span><span class="p">(</span><span class="n">input_size</span><span class="p">),</span>
                <span class="n">T</span><span class="o">.</span><span class="n">ToTensor</span><span class="p">(),</span>
                <span class="n">T</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">mean</span><span class="o">=</span><span class="p">[</span><span class="mf">0.485</span><span class="p">,</span> <span class="mf">0.456</span><span class="p">,</span> <span class="mf">0.406</span><span class="p">],</span> <span class="n">std</span><span class="o">=</span><span class="p">[</span><span class="mf">0.229</span><span class="p">,</span> <span class="mf">0.224</span><span class="p">,</span> <span class="mf">0.225</span><span class="p">]),</span>
            <span class="p">])</span>
        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image_transform</span><span class="p">,</span> <span class="s1">&#39;crop_size&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image_transform</span><span class="o">.</span><span class="n">crop_size</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_transform</span><span class="o">.</span><span class="n">crop_size</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;input_size&quot;</span><span class="p">,</span> <span class="mi">224</span><span class="p">):</span>
            <span class="k">pass</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_load_image_model_timm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timm_model_name</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">timm</span><span class="p">,</span> <span class="s1">&#39;create_model&#39;</span><span class="p">):</span> 
             <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s2">&quot;TIMM library is not installed. Please install it: pip install timm&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">timm</span><span class="o">.</span><span class="n">create_model</span><span class="p">(</span><span class="n">timm_model_name</span><span class="p">,</span> <span class="n">pretrained</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">num_classes</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="n">data_config</span> <span class="o">=</span> <span class="n">timm</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">resolve_data_config</span><span class="p">({},</span> <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_transform</span> <span class="o">=</span> <span class="n">timm</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">create_transform</span><span class="p">(</span><span class="o">**</span><span class="n">data_config</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;input_size&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;input_size&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_config</span><span class="p">[</span><span class="s1">&#39;input_size&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> 

    <span class="k">def</span><span class="w"> </span><span class="nf">_load_image_model_dinov2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">Dinov2Model</span><span class="p">,</span> <span class="s1">&#39;from_pretrained&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">AutoImageProcessor</span><span class="p">,</span> <span class="s1">&#39;from_pretrained&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span>
                <span class="s2">&quot;Transformers components (Dinov2Model or AutoImageProcessor) not available or are dummy classes. &quot;</span>
                <span class="s2">&quot;Update transformers: pip install --upgrade transformers&quot;</span>
            <span class="p">)</span>
        <span class="n">hf_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;hf_name&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">processor</span> <span class="o">=</span> <span class="n">AutoImageProcessor</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">hf_name</span><span class="p">)</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">Dinov2Model</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">hf_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_load_model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">source</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">video_frame_transform</span> <span class="o">=</span> <span class="kc">None</span> 

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">task_type</span> <span class="o">==</span> <span class="s2">&quot;image&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_name</span> <span class="o">==</span> <span class="s2">&quot;dinov2_base&quot;</span><span class="p">:</span> 
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">Dinov2Model</span><span class="p">,</span> <span class="s1">&#39;from_pretrained&#39;</span><span class="p">):</span> 
                    <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s2">&quot;Transformers (Dinov2Model) dummy class detected or not installed.&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_load_image_model_dinov2</span><span class="p">()</span> 
            <span class="k">elif</span> <span class="n">source</span> <span class="o">==</span> <span class="s2">&quot;torchvision&quot;</span><span class="p">:</span> 
                <span class="bp">self</span><span class="o">.</span><span class="n">_load_image_model_torchvision</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_name</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">source</span> <span class="o">==</span> <span class="s2">&quot;torchvision_or_timm&quot;</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">timm</span><span class="p">,</span> <span class="s1">&#39;create_model&#39;</span><span class="p">):</span> <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s2">&quot;TIMM not available&quot;</span><span class="p">)</span>
                    <span class="n">timm_model_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;timm_name&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_name</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_load_image_model_timm</span><span class="p">(</span><span class="n">timm_model_id</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span> 
                    <span class="bp">self</span><span class="o">.</span><span class="n">_load_image_model_torchvision</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_name</span><span class="p">)</span> 
            <span class="k">elif</span> <span class="n">source</span> <span class="o">==</span> <span class="s2">&quot;timm&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">timm</span><span class="p">,</span> <span class="s1">&#39;create_model&#39;</span><span class="p">):</span> <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s2">&quot;TIMM not available&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_load_image_model_timm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;timm_name&quot;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported image model source for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">source</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">task_type</span> <span class="o">==</span> <span class="s2">&quot;text&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">source</span> <span class="o">==</span> <span class="s2">&quot;sentence-transformers&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">SentenceTransformer</span><span class="p">,</span> <span class="s1">&#39;encode&#39;</span><span class="p">):</span> 
                     <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s2">&quot;Sentence-Transformers dummy class detected or not installed.&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">SentenceTransformer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;st_name&quot;</span><span class="p">],</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">source</span> <span class="o">==</span> <span class="s2">&quot;transformers&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">AutoTokenizer</span><span class="p">,</span> <span class="s1">&#39;from_pretrained&#39;</span><span class="p">):</span> 
                    <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s2">&quot;Transformers (AutoTokenizer) dummy class detected or not installed.&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">AutoTokenizer</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;hf_name&quot;</span><span class="p">],</span> <span class="n">use_fast</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">AutoModel</span><span class="p">,</span> <span class="s1">&#39;from_pretrained&#39;</span><span class="p">):</span>
                     <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s2">&quot;Transformers (AutoModel) dummy class detected or not installed.&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">AutoModel</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;hf_name&quot;</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported text model source: </span><span class="si">{</span><span class="n">source</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">task_type</span> <span class="o">==</span> <span class="s2">&quot;video&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">source</span> <span class="o">==</span> <span class="s2">&quot;torchvision&quot;</span><span class="p">:</span>
                <span class="n">actual_tv_model_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tv_model_name&quot;</span><span class="p">)</span> 
                <span class="k">if</span> <span class="ow">not</span> <span class="n">actual_tv_model_name</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Configuration for torchvision video model </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model_name</span><span class="si">}</span><span class="s2"> is missing &#39;tv_model_name&#39;.&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">tv_video_models</span><span class="p">,</span> <span class="n">actual_tv_model_name</span><span class="p">):</span> 
                    <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Video model &#39;</span><span class="si">{</span><span class="n">actual_tv_model_name</span><span class="si">}</span><span class="s2">&#39; not found in torchvision.models.video.&quot;</span><span class="p">)</span>
                <span class="n">model_fn</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">tv_video_models</span><span class="p">,</span> <span class="n">actual_tv_model_name</span><span class="p">)</span>
                <span class="n">weights_enum_name_map</span> <span class="o">=</span> <span class="p">{</span> 
                    <span class="s2">&quot;r2plus1d_18&quot;</span><span class="p">:</span> <span class="s2">&quot;R2Plus1D_18_Weights&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;swin3d_t&quot;</span><span class="p">:</span> <span class="s2">&quot;Swin3D_T_Weights&quot;</span><span class="p">,</span> 
                    <span class="s2">&quot;swin3d_s&quot;</span><span class="p">:</span> <span class="s2">&quot;Swin3D_S_Weights&quot;</span><span class="p">,</span> 
                    <span class="s2">&quot;swin3d_b&quot;</span><span class="p">:</span> <span class="s2">&quot;Swin3D_B_Weights&quot;</span><span class="p">,</span> 
                <span class="p">}</span>
                <span class="n">lookup_key_for_map</span> <span class="o">=</span> <span class="n">actual_tv_model_name</span> 
                <span class="n">weights_enum_name</span> <span class="o">=</span> <span class="n">weights_enum_name_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">lookup_key_for_map</span><span class="p">)</span>
                <span class="n">weights_value_name</span> <span class="o">=</span> <span class="s2">&quot;DEFAULT&quot;</span> 
                <span class="k">if</span> <span class="n">weights_enum_name</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">weights_enum_class</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">tv_video_models</span><span class="p">,</span> <span class="n">weights_enum_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">weights_enum_class</span><span class="p">:</span>
                            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">weights_enum_class</span><span class="p">,</span> <span class="n">weights_value_name</span><span class="p">):</span> <span class="n">weights_obj</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">weights_enum_class</span><span class="p">,</span> <span class="n">weights_value_name</span><span class="p">)</span>
                            <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">weights_enum_class</span><span class="p">,</span> <span class="s1">&#39;KINETICS400_V1&#39;</span><span class="p">):</span> <span class="n">weights_obj</span> <span class="o">=</span> <span class="n">weights_enum_class</span><span class="o">.</span><span class="n">KINETICS400_V1</span>
                            <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">weights_enum_class</span><span class="p">,</span> <span class="s1">&#39;KINETICS400_IMAGENET1K_V1&#39;</span><span class="p">):</span> <span class="n">weights_obj</span> <span class="o">=</span> <span class="n">weights_enum_class</span><span class="o">.</span><span class="n">KINETICS400_IMAGENET1K_V1</span>
                            <span class="k">else</span><span class="p">:</span> 
                                <span class="n">available_weights</span> <span class="o">=</span> <span class="p">[</span><span class="n">w</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">weights_enum_class</span><span class="p">)</span> <span class="k">if</span> <span class="n">w</span><span class="o">.</span><span class="n">isupper</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">w</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)]</span>
                                <span class="k">if</span> <span class="n">available_weights</span><span class="p">:</span>
                                    <span class="n">weights_obj</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">weights_enum_class</span><span class="p">,</span> <span class="n">available_weights</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;DLFeat: Using first available weight &#39;</span><span class="si">{</span><span class="n">available_weights</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39; for </span><span class="si">{</span><span class="n">actual_tv_model_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                                <span class="k">else</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No suitable weights found in </span><span class="si">{</span><span class="n">weights_enum_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                            
                            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model_fn</span><span class="p">(</span><span class="n">weights</span><span class="o">=</span><span class="n">weights_obj</span><span class="p">)</span>
                            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">weights_obj</span><span class="p">,</span> <span class="s1">&#39;transforms&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">callable</span><span class="p">(</span><span class="n">weights_obj</span><span class="o">.</span><span class="n">transforms</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">video_frame_transform</span> <span class="o">=</span> <span class="n">weights_obj</span><span class="o">.</span><span class="n">transforms</span><span class="p">()</span>
                        <span class="k">else</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">weights_enum_name</span><span class="si">}</span><span class="s2"> enum not found for </span><span class="si">{</span><span class="n">actual_tv_model_name</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
                    <span class="k">except</span> <span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e_new_api</span><span class="p">:</span>
                        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;DLFeatExtractor: Failed to use new &#39;weights&#39; API for </span><span class="si">{</span><span class="n">actual_tv_model_name</span><span class="si">}</span><span class="s2"> (Error: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">e_new_api</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e_new_api</span><span class="si">}</span><span class="s2">). &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;Falling back to legacy &#39;pretrained=True&#39; if applicable.&quot;</span>
                        <span class="p">)</span>
                        <span class="kn">import</span><span class="w"> </span><span class="nn">inspect</span>
                        <span class="n">sig</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">model_fn</span><span class="p">)</span>
                        <span class="k">if</span> <span class="s1">&#39;pretrained&#39;</span> <span class="ow">in</span> <span class="n">sig</span><span class="o">.</span><span class="n">parameters</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model_fn</span><span class="p">(</span><span class="n">pretrained</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span> 
                            <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;New weights API failed for </span><span class="si">{</span><span class="n">actual_tv_model_name</span><span class="si">}</span><span class="s2"> and legacy &#39;pretrained&#39; not supported or model init failed. Error: </span><span class="si">{</span><span class="n">e_new_api</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span> 
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;DLFeatExtractor: No specific &#39;weights&#39; API logic for </span><span class="si">{</span><span class="n">actual_tv_model_name</span><span class="si">}</span><span class="s2"> (lookup key: </span><span class="si">{</span><span class="n">lookup_key_for_map</span><span class="si">}</span><span class="s2">). Attempting legacy &#39;pretrained=True&#39;.&quot;</span>
                    <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model_fn</span><span class="p">(</span><span class="n">pretrained</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> 

                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;head&#39;</span><span class="p">):</span> 
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">head</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">head</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Identity</span><span class="p">()</span>
                    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">head</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">head</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">head</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">head</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Identity</span><span class="p">()</span>
                <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;fc&#39;</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">fc</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Identity</span><span class="p">()</span> 
                
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">video_frame_transform</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> 
                    <span class="n">input_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;input_size&quot;</span><span class="p">,</span> <span class="mi">224</span><span class="p">)</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;DLFeat: Using manual basic per-frame transforms for </span><span class="si">{</span><span class="n">actual_tv_model_name</span><span class="si">}</span><span class="s2"> as weights.transforms() was not available/used for video_frame_transform.&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">video_frame_transform</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">Compose</span><span class="p">([</span> 
                        <span class="n">T</span><span class="o">.</span><span class="n">ConvertImageDtype</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> 
                        <span class="n">T</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">mean</span><span class="o">=</span><span class="p">[</span><span class="mf">0.43216</span><span class="p">,</span> <span class="mf">0.394666</span><span class="p">,</span> <span class="mf">0.37645</span><span class="p">],</span> <span class="n">std</span><span class="o">=</span><span class="p">[</span><span class="mf">0.22803</span><span class="p">,</span> <span class="mf">0.22145</span><span class="p">,</span> <span class="mf">0.216989</span><span class="p">]),</span> 
                        <span class="n">T</span><span class="o">.</span><span class="n">Resize</span><span class="p">([</span><span class="n">input_size</span><span class="p">,</span> <span class="n">input_size</span><span class="p">],</span> <span class="n">antialias</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> 
                    <span class="p">])</span>
            
            <span class="k">elif</span> <span class="n">source</span> <span class="o">==</span> <span class="s2">&quot;transformers&quot;</span><span class="p">:</span> 
                <span class="n">hf_model_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;hf_name&quot;</span><span class="p">]</span>
                <span class="n">hf_processor_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;hf_name_processor&quot;</span><span class="p">,</span> <span class="n">hf_model_name</span><span class="p">)</span> 

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;videomae&quot;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">VideoMAEImageProcessor</span><span class="p">,</span> <span class="s1">&#39;from_pretrained&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">VideoMAEModel</span><span class="p">,</span> <span class="s1">&#39;from_pretrained&#39;</span><span class="p">):</span>
                        <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s2">&quot;VideoMAE components from Transformers not available or are dummy classes.&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">processor</span> <span class="o">=</span> <span class="n">VideoMAEImageProcessor</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">hf_processor_name</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">VideoMAEModel</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">hf_model_name</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span> 
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported transformers video model: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported video model source: </span><span class="si">{</span><span class="n">source</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">task_type</span> <span class="o">==</span> <span class="s2">&quot;audio&quot;</span><span class="p">:</span>
            <span class="n">ProcessorCheckClass</span> <span class="o">=</span> <span class="n">ASTFeatureExtractor</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;ast&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="n">Wav2Vec2FeatureExtractor</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">ProcessorCheckClass</span><span class="p">,</span> <span class="s1">&#39;from_pretrained&#39;</span><span class="p">):</span> 
                <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Transformers (</span><span class="si">{</span><span class="n">ProcessorCheckClass</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">) dummy class detected or not installed.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">TA</span><span class="p">,</span> <span class="s1">&#39;Resample&#39;</span><span class="p">):</span>  
                <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s2">&quot;Torchaudio (transforms.Resample) dummy class detected or not installed.&quot;</span><span class="p">)</span>
            <span class="n">hf_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;hf_name&quot;</span><span class="p">]</span>
            <span class="n">ProcessorClassToUse</span> <span class="o">=</span> <span class="n">ASTFeatureExtractor</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;ast&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="n">Wav2Vec2FeatureExtractor</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">processor</span> <span class="o">=</span> <span class="n">ProcessorClassToUse</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">hf_name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">AutoModel</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">hf_name</span><span class="p">)</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">target_sr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;sampling_rate&quot;</span><span class="p">]</span> 

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">task_type</span> <span class="o">==</span> <span class="s2">&quot;multimodal_image_text&quot;</span><span class="p">:</span>
            <span class="n">ProcessorCheckClass</span> <span class="o">=</span> <span class="n">BlipProcessor</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;blip&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="n">CLIPProcessor</span>
            <span class="n">ModelCheckClass</span> <span class="o">=</span> <span class="n">BlipModel</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;blip&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="n">CLIPModel</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">ProcessorCheckClass</span><span class="p">,</span> <span class="s1">&#39;from_pretrained&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">ModelCheckClass</span><span class="p">,</span> <span class="s1">&#39;from_pretrained&#39;</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Transformers (</span><span class="si">{</span><span class="n">ProcessorCheckClass</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> or </span><span class="si">{</span><span class="n">ModelCheckClass</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">) dummy class detected or not installed.&quot;</span><span class="p">)</span>
            <span class="n">hf_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;hf_name&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">processor</span> <span class="o">=</span> <span class="n">ProcessorCheckClass</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">hf_name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">ModelCheckClass</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">hf_name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">task_type</span> <span class="o">==</span> <span class="s2">&quot;multimodal_video_text&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">XCLIPProcessor</span><span class="p">,</span> <span class="s1">&#39;from_pretrained&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">XCLIPModel</span><span class="p">,</span> <span class="s1">&#39;from_pretrained&#39;</span><span class="p">):</span> 
                <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s2">&quot;Transformers (XCLIP components) dummy class detected or not installed.&quot;</span><span class="p">)</span>
            <span class="n">hf_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;hf_name&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">processor</span> <span class="o">=</span> <span class="n">XCLIPProcessor</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">hf_name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">XCLIPModel</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">hf_name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
            
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported task type: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">task_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
    <span class="k">def</span><span class="w"> </span><span class="nf">_preprocess_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image_input</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">image_input</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">image_input</span><span class="p">):</span> <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Image file: </span><span class="si">{</span><span class="n">image_input</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">image_input</span><span class="p">)</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s2">&quot;RGB&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">image_input</span><span class="p">,</span> <span class="n">Image</span><span class="o">.</span><span class="n">Image</span><span class="p">):</span> <span class="n">img</span> <span class="o">=</span> <span class="n">image_input</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s2">&quot;RGB&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Image input must be a file path or PIL Image.&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_name</span> <span class="o">==</span> <span class="s2">&quot;dinov2_base&quot;</span><span class="p">:</span> 
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">processor</span><span class="p">(</span><span class="n">images</span><span class="o">=</span><span class="n">img</span><span class="p">,</span> <span class="n">return_tensors</span><span class="o">=</span><span class="s2">&quot;pt&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_transform</span><span class="p">:</span> 
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_transform</span><span class="p">(</span><span class="n">img</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> 
        <span class="k">else</span><span class="p">:</span> 
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No image transform or processor available for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_preprocess_text_transformers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text_input</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">(</span><span class="n">text_input</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">truncation</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">return_tensors</span><span class="o">=</span><span class="s2">&quot;pt&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_preprocess_video_torchvision</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">video_path</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">video_path</span><span class="p">):</span> <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Video file: </span><span class="si">{</span><span class="n">video_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Reverted to default output_format</span>
            <span class="n">frames</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="n">torchvision</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">read_video</span><span class="p">(</span><span class="n">video_path</span><span class="p">,</span> <span class="n">pts_unit</span><span class="o">=</span><span class="s1">&#39;sec&#39;</span><span class="p">)</span> 
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to read </span><span class="si">{</span><span class="n">video_path</span><span class="si">}</span><span class="s2"> using torchvision.io: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">frames</span><span class="o">.</span><span class="n">numel</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No frames from </span><span class="si">{</span><span class="n">video_path</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        
        <span class="c1"># Assuming default output is THWC (Time, Height, Width, Channel)</span>
        <span class="n">frames</span> <span class="o">=</span> <span class="n">frames</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="c1"># T, C, H, W uint8</span>

        <span class="n">total_frames</span> <span class="o">=</span> <span class="n">frames</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">clip_len</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;clip_len&quot;</span><span class="p">,</span> <span class="mi">32</span><span class="p">)</span> 
        
        <span class="k">if</span> <span class="n">total_frames</span> <span class="o">&lt;</span> <span class="n">clip_len</span><span class="p">:</span> 
            <span class="n">padding_count</span> <span class="o">=</span> <span class="n">clip_len</span> <span class="o">-</span> <span class="n">total_frames</span>
            <span class="n">padding_frames</span> <span class="o">=</span> <span class="n">frames</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">padding_count</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> 
            <span class="n">sampled_frames</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">frames</span><span class="p">,</span> <span class="n">padding_frames</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> 
            <span class="n">indices</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">total_frames</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">steps</span><span class="o">=</span><span class="n">clip_len</span><span class="p">)</span><span class="o">.</span><span class="n">long</span><span class="p">()</span>
            <span class="n">sampled_frames</span> <span class="o">=</span> <span class="n">frames</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span> 

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">video_frame_transform</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">processed_clip</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">video_frame_transform</span><span class="p">(</span><span class="n">sampled_frames</span><span class="p">)</span> 
                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">processed_clip</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">4</span> <span class="ow">and</span> <span class="n">processed_clip</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">processed_clip</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">clip_len</span><span class="p">):</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;DLFeat: Video transform for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model_name</span><span class="si">}</span><span class="s2"> output shape </span><span class="si">{</span><span class="n">processed_clip</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2"> &quot;</span>
                                  <span class="sa">f</span><span class="s2">&quot;unexpected. Expected (3, </span><span class="si">{</span><span class="n">clip_len</span><span class="si">}</span><span class="s2">, H, W). Permuting if T,C,H,W was output.&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">processed_clip</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">4</span> <span class="ow">and</span> <span class="n">processed_clip</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">processed_clip</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">clip_len</span><span class="p">:</span> <span class="c1"># T,C,H,W</span>
                        <span class="n">processed_clip</span> <span class="o">=</span> <span class="n">processed_clip</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="c1"># C,T,H,W</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e_transform</span><span class="p">:</span>
                 <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error applying self.video_frame_transform for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e_transform</span><span class="si">}</span><span class="s2">. &quot;</span>
                                    <span class="sa">f</span><span class="s2">&quot;Input shape to transform was </span><span class="si">{</span><span class="n">sampled_frames</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">, transform type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">video_frame_transform</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> 
            <span class="n">input_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;input_size&quot;</span><span class="p">,</span> <span class="mi">224</span><span class="p">)</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;DLFeat: Using manual basic per-frame transforms for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model_name</span><span class="si">}</span><span class="s2"> as weights.transforms() was not available/used for video_frame_transform.&quot;</span><span class="p">)</span>
            <span class="n">manual_per_frame_transform</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">Compose</span><span class="p">([</span> 
                 <span class="n">T</span><span class="o">.</span><span class="n">ToPILImage</span><span class="p">(),</span> 
                 <span class="n">T</span><span class="o">.</span><span class="n">Resize</span><span class="p">([</span><span class="n">input_size</span><span class="p">,</span> <span class="n">input_size</span><span class="p">],</span> <span class="n">antialias</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
                 <span class="n">T</span><span class="o">.</span><span class="n">ToTensor</span><span class="p">(),</span> 
                 <span class="n">T</span><span class="o">.</span><span class="n">ConvertImageDtype</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> 
                 <span class="n">T</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">mean</span><span class="o">=</span><span class="p">[</span><span class="mf">0.43216</span><span class="p">,</span> <span class="mf">0.394666</span><span class="p">,</span> <span class="mf">0.37645</span><span class="p">],</span> <span class="n">std</span><span class="o">=</span><span class="p">[</span><span class="mf">0.22803</span><span class="p">,</span> <span class="mf">0.22145</span><span class="p">,</span> <span class="mf">0.216989</span><span class="p">]),</span>
            <span class="p">])</span>
            <span class="n">processed_frames_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">manual_per_frame_transform</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span> <span class="k">for</span> <span class="n">frame</span> <span class="ow">in</span> <span class="n">sampled_frames</span><span class="p">]</span> 
            <span class="n">processed_clip_temp</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">processed_frames_list</span><span class="p">)</span> 
            <span class="n">processed_clip</span> <span class="o">=</span> <span class="n">processed_clip_temp</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> 
            
        <span class="k">return</span> <span class="n">processed_clip</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> 

    <span class="k">def</span><span class="w"> </span><span class="nf">_preprocess_video_transformers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">video_path</span><span class="p">):</span> 
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">video_path</span><span class="p">):</span> <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Video file: </span><span class="si">{</span><span class="n">video_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Reverted to default output_format</span>
            <span class="n">frames_tensor</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">torchvision</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">read_video</span><span class="p">(</span><span class="n">video_path</span><span class="p">,</span> <span class="n">pts_unit</span><span class="o">=</span><span class="s1">&#39;sec&#39;</span><span class="p">)</span> 
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to read </span><span class="si">{</span><span class="n">video_path</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">frames_tensor</span><span class="o">.</span><span class="n">numel</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No frames from </span><span class="si">{</span><span class="n">video_path</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        
        <span class="c1"># Assuming default output is THWC (Time, Height, Width, Channel)</span>
        
        <span class="n">total_frames</span> <span class="o">=</span> <span class="n">frames_tensor</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">num_sample_frames</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;num_frames&quot;</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span> 
        
        <span class="k">if</span> <span class="n">total_frames</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Video </span><span class="si">{</span><span class="n">video_path</span><span class="si">}</span><span class="s2"> has 0 frames.&quot;</span><span class="p">)</span>
        <span class="n">actual_samples_to_take</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">num_sample_frames</span><span class="p">,</span> <span class="n">total_frames</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">total_frames</span> <span class="o">&lt;</span> <span class="n">num_sample_frames</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Video </span><span class="si">{</span><span class="n">video_path</span><span class="si">}</span><span class="s2"> has </span><span class="si">{</span><span class="n">total_frames</span><span class="si">}</span><span class="s2"> frames, less than configured </span><span class="si">{</span><span class="n">num_sample_frames</span><span class="si">}</span><span class="s2">. Using all </span><span class="si">{</span><span class="n">total_frames</span><span class="si">}</span><span class="s2"> frames and padding.&quot;</span><span class="p">)</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">total_frames</span><span class="p">)</span>
            <span class="n">padding_needed</span> <span class="o">=</span> <span class="n">num_sample_frames</span> <span class="o">-</span> <span class="n">total_frames</span>
            <span class="c1"># frames_tensor is (T,H,W,C) assuming default THWC</span>
            <span class="n">video_frames_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="n">frames_tensor</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">padding_needed</span><span class="p">):</span> <span class="n">video_frames_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">video_frames_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">total_frames</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">num_sample_frames</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
            <span class="n">video_frames_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="n">frames_tensor</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">]</span> 

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;xclip&quot;</span><span class="p">):</span> 
            <span class="k">return</span> <span class="n">video_frames_list</span>
        <span class="k">else</span><span class="p">:</span> <span class="c1"># VideoMAE</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">processor</span><span class="p">(</span><span class="n">images</span><span class="o">=</span><span class="n">video_frames_list</span><span class="p">,</span> <span class="n">return_tensors</span><span class="o">=</span><span class="s2">&quot;pt&quot;</span><span class="p">)</span> 
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_preprocess_audio</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">audio_input</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">TA</span><span class="p">,</span> <span class="s1">&#39;Resample&#39;</span><span class="p">):</span> 
             <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s2">&quot;Torchaudio (transforms.Resample) dummy class detected or not installed.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">audio_input</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">audio_input</span><span class="p">):</span> <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Audio file: </span><span class="si">{</span><span class="n">audio_input</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span> <span class="n">waveform</span><span class="p">,</span> <span class="n">sr</span> <span class="o">=</span> <span class="n">torchaudio</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">audio_input</span><span class="p">)</span> 
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to load </span><span class="si">{</span><span class="n">audio_input</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Audio input must be a file path.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sr</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_sr</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">audio_resampler</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">audio_resampler</span><span class="o">.</span><span class="n">orig_freq</span> <span class="o">!=</span> <span class="n">sr</span><span class="p">:</span>
                <span class="n">ResamplerClass</span> <span class="o">=</span> <span class="n">TA</span><span class="o">.</span><span class="n">Resample</span> 
                <span class="bp">self</span><span class="o">.</span><span class="n">audio_resampler</span> <span class="o">=</span> <span class="n">ResamplerClass</span><span class="p">(</span><span class="n">orig_freq</span><span class="o">=</span><span class="n">sr</span><span class="p">,</span> <span class="n">new_freq</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">target_sr</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">waveform</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">waveform</span><span class="o">.</span><span class="n">device</span><span class="p">)</span> 
            <span class="n">waveform</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">audio_resampler</span><span class="p">(</span><span class="n">waveform</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">waveform</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span> <span class="n">waveform</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">waveform</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> 
        <span class="n">processed_input_data</span> <span class="o">=</span> <span class="n">waveform</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span> 
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;ast&quot;</span><span class="p">):</span> <span class="n">processed_input_data</span> <span class="o">=</span> <span class="n">waveform</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> 
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">processor</span><span class="p">(</span><span class="n">processed_input_data</span><span class="p">,</span> <span class="n">sampling_rate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">target_sr</span><span class="p">,</span> <span class="n">return_tensors</span><span class="o">=</span><span class="s2">&quot;pt&quot;</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


<div class="viewcode-block" id="DLFeatExtractor.transform">
<a class="viewcode-back" href="../index.html#DLFeat.DLFeatExtractor.transform">[docs]</a>
    <span class="nd">@torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">()</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span> <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Input X for transform must be a list of items.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">X</span><span class="p">:</span> 
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">task_type</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;multimodal&quot;</span><span class="p">):</span> <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;image_features&quot;</span><span class="p">,</span> <span class="s2">&quot;text_features&quot;</span><span class="p">,</span> <span class="s2">&quot;video_features&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">task_type</span><span class="p">}</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="n">all_features_batches</span> <span class="o">=</span> <span class="p">[]</span> 

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">task_type</span> <span class="o">==</span> <span class="s2">&quot;image&quot;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">),</span> <span class="n">batch_size</span><span class="p">):</span>
                <span class="n">batch_items</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">batch_size</span><span class="p">]</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_name</span> <span class="o">==</span> <span class="s2">&quot;dinov2_base&quot;</span><span class="p">:</span>
                    <span class="n">pil_images</span> <span class="o">=</span> <span class="p">[</span><span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">item</span><span class="p">)</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s2">&quot;RGB&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">item</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s2">&quot;RGB&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">batch_items</span><span class="p">]</span>
                    <span class="n">inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">processor</span><span class="p">(</span><span class="n">images</span><span class="o">=</span><span class="n">pil_images</span><span class="p">,</span> <span class="n">return_tensors</span><span class="o">=</span><span class="s2">&quot;pt&quot;</span><span class="p">)</span> 
                    <span class="n">inputs</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">inputs</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span> 
                    <span class="n">outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="o">**</span><span class="n">inputs</span><span class="p">)</span>
                    <span class="n">features</span> <span class="o">=</span> <span class="n">outputs</span><span class="o">.</span><span class="n">pooler_output</span> 
                <span class="k">else</span><span class="p">:</span> 
                    <span class="n">processed_batch_tensors</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_preprocess_image</span><span class="p">(</span><span class="n">item</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">batch_items</span><span class="p">]</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">processed_batch_tensors</span><span class="p">:</span> <span class="k">continue</span>
                    <span class="n">final_batch_tensor</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">processed_batch_tensors</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
                    <span class="n">features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">final_batch_tensor</span><span class="p">)</span>
                <span class="n">all_features_batches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">features</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">task_type</span> <span class="o">==</span> <span class="s2">&quot;text&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;sentence-transformers&quot;</span><span class="p">:</span>
                <span class="n">features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">convert_to_numpy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
                <span class="n">all_features_batches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span> 
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">),</span> <span class="n">batch_size</span><span class="p">):</span>
                    <span class="n">batch_texts</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">batch_size</span><span class="p">]</span>
                    <span class="n">inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_preprocess_text_transformers</span><span class="p">(</span><span class="n">batch_texts</span><span class="p">)</span>
                    <span class="n">inputs</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">inputs</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
                    <span class="n">outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="o">**</span><span class="n">inputs</span><span class="p">)</span>
                    <span class="n">features</span> <span class="o">=</span> <span class="n">outputs</span><span class="o">.</span><span class="n">last_hidden_state</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span> 
                    <span class="n">all_features_batches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>
        
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">task_type</span> <span class="o">==</span> <span class="s2">&quot;video&quot;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">),</span> <span class="n">batch_size</span><span class="p">):</span>
                <span class="n">batch_video_paths</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">batch_size</span><span class="p">]</span>
                <span class="n">processed_clips_tensors</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;transformers&quot;</span><span class="p">:</span>
                    <span class="n">pixel_values_list</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">video_path</span> <span class="ow">in</span> <span class="n">batch_video_paths</span><span class="p">:</span>
                        <span class="n">processed_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_preprocess_video_transformers</span><span class="p">(</span><span class="n">video_path</span><span class="p">)</span>
                        <span class="n">pixel_values_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">processed_output</span><span class="p">[</span><span class="s1">&#39;pixel_values&#39;</span><span class="p">])</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">pixel_values_list</span><span class="p">:</span> <span class="k">continue</span>
                    <span class="n">batch_tensor</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">pixel_values_list</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span> <span class="c1"># torchvision</span>
                    <span class="k">for</span> <span class="n">video_path</span> <span class="ow">in</span> <span class="n">batch_video_paths</span><span class="p">:</span>
                        <span class="n">clip_tensor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_preprocess_video_torchvision</span><span class="p">(</span><span class="n">video_path</span><span class="p">)</span> 
                        <span class="n">processed_clips_tensors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">clip_tensor</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">processed_clips_tensors</span><span class="p">:</span> <span class="k">continue</span>
                    <span class="n">batch_tensor</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">processed_clips_tensors</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
                
                <span class="n">outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">pixel_values</span><span class="o">=</span><span class="n">batch_tensor</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;transformers&quot;</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">batch_tensor</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="s1">&#39;pooler_output&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">outputs</span><span class="o">.</span><span class="n">pooler_output</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> 
                    <span class="n">features</span> <span class="o">=</span> <span class="n">outputs</span><span class="o">.</span><span class="n">pooler_output</span>
                <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="s1">&#39;last_hidden_state&#39;</span><span class="p">):</span> 
                    <span class="n">features</span> <span class="o">=</span> <span class="n">outputs</span><span class="o">.</span><span class="n">last_hidden_state</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> 
                <span class="k">else</span><span class="p">:</span> 
                    <span class="n">features</span> <span class="o">=</span> <span class="n">outputs</span> 
                <span class="n">all_features_batches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">features</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">task_type</span> <span class="o">==</span> <span class="s2">&quot;audio&quot;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">),</span> <span class="n">batch_size</span><span class="p">):</span>
                <span class="n">batch_audio_paths</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">batch_size</span><span class="p">]</span>
                <span class="n">batch_item_features_list</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">audio_path</span> <span class="ow">in</span> <span class="n">batch_audio_paths</span><span class="p">:</span>
                    <span class="n">inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_preprocess_audio</span><span class="p">(</span><span class="n">audio_path</span><span class="p">)</span> 
                    <span class="n">inputs</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">inputs</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
                    <span class="n">outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="o">**</span><span class="n">inputs</span><span class="p">)</span>
                    <span class="n">item_features</span> <span class="o">=</span> <span class="n">outputs</span><span class="o">.</span><span class="n">last_hidden_state</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> 
                    <span class="n">batch_item_features_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item_features</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">batch_item_features_list</span><span class="p">:</span>
                    <span class="n">stacked_features</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">batch_item_features_list</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">all_features_batches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stacked_features</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">task_type</span> <span class="o">==</span> <span class="s2">&quot;multimodal_image_text&quot;</span><span class="p">:</span>
            <span class="n">img_feats_list</span><span class="p">,</span> <span class="n">text_feats_list</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">),</span> <span class="n">batch_size</span><span class="p">):</span>
                <span class="n">batch_tuples</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">batch_size</span><span class="p">]</span>
                <span class="n">pil_images</span> <span class="o">=</span> <span class="p">[</span><span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s2">&quot;RGB&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s2">&quot;RGB&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">batch_tuples</span><span class="p">]</span>
                <span class="n">str_texts</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">batch_tuples</span><span class="p">]</span>
                <span class="n">inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">processor</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">str_texts</span><span class="p">,</span> <span class="n">images</span><span class="o">=</span><span class="n">pil_images</span><span class="p">,</span> <span class="n">return_tensors</span><span class="o">=</span><span class="s2">&quot;pt&quot;</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">truncation</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">inputs</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">inputs</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;clip&quot;</span><span class="p">):</span>
                    <span class="n">outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="o">**</span><span class="n">inputs</span><span class="p">)</span>
                    <span class="n">img_feats_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">outputs</span><span class="o">.</span><span class="n">image_embeds</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
                    <span class="n">text_feats_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">outputs</span><span class="o">.</span><span class="n">text_embeds</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
                <span class="k">else</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">NotImplementedError</span> 
            <span class="n">final_output_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;image_features&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">img_feats_list</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="k">if</span> <span class="n">img_feats_list</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([]),</span>
                                 <span class="s2">&quot;text_features&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">text_feats_list</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="k">if</span> <span class="n">text_feats_list</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])}</span>
            <span class="k">return</span> <span class="n">final_output_dict</span>


        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">task_type</span> <span class="o">==</span> <span class="s2">&quot;multimodal_video_text&quot;</span><span class="p">:</span> <span class="c1"># XCLIP</span>
            <span class="n">vid_feats_list</span><span class="p">,</span> <span class="n">txt_feats_list</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">),</span> <span class="n">batch_size</span><span class="p">):</span> 
                <span class="n">batch_tuples</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">batch_size</span><span class="p">]</span>
                <span class="n">batch_video_pil_frames</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_preprocess_video_transformers</span><span class="p">(</span><span class="n">video_path</span><span class="p">)</span> <span class="k">for</span> <span class="n">video_path</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">batch_tuples</span><span class="p">]</span> 
                <span class="n">text_queries</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">batch_tuples</span><span class="p">]</span>
                <span class="n">inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">processor</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">text_queries</span><span class="p">,</span> <span class="n">videos</span><span class="o">=</span><span class="n">batch_video_pil_frames</span><span class="p">,</span> <span class="n">return_tensors</span><span class="o">=</span><span class="s2">&quot;pt&quot;</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">inputs</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">inputs</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
                <span class="n">outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="o">**</span><span class="n">inputs</span><span class="p">)</span> 
                
                <span class="c1"># Corrected XCLIP feature extraction:</span>
                <span class="c1"># outputs.video_embeds and outputs.text_embeds are the final (batch_size, output_dim) tensors</span>
                <span class="n">video_f</span> <span class="o">=</span> <span class="n">outputs</span><span class="o">.</span><span class="n">video_embeds</span>
                <span class="n">text_f</span> <span class="o">=</span> <span class="n">outputs</span><span class="o">.</span><span class="n">text_embeds</span>
                
                <span class="n">vid_feats_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">video_f</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
                <span class="n">txt_feats_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">text_f</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>   

            <span class="n">final_output_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;video_features&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">vid_feats_list</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="k">if</span> <span class="n">vid_feats_list</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([]),</span>
                                 <span class="s2">&quot;text_features&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">txt_feats_list</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="k">if</span> <span class="n">txt_feats_list</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])}</span>
            <span class="k">return</span> <span class="n">final_output_dict</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Transform not implemented for task type: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">task_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">all_features_batches</span><span class="p">:</span> <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="n">final_features_np</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">all_features_batches</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">final_features_np</span></div>
</div>


<span class="c1"># --- Self-Test Suite ---</span>
<span class="n">DUMMY_VIDEO_URL</span> <span class="o">=</span> <span class="s2">&quot;https://dl.fbaipublicfiles.com/pytorchvideo/projects/archery.mp4&quot;</span>
<span class="n">DUMMY_VIDEO_FILENAME</span> <span class="o">=</span> <span class="s2">&quot;dlfeat_sample_video.mp4&quot;</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_create_dummy_image</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="s2">&quot;dummy_image_dlfeat.png&quot;</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">&#39;RGB&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">224</span><span class="p">,</span> <span class="mi">224</span><span class="p">),</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;red&#39;</span><span class="p">)</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">ImageDraw</span><span class="o">.</span><span class="n">Draw</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
        <span class="n">d</span><span class="o">.</span><span class="n">text</span><span class="p">((</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">),</span> <span class="s2">&quot;Hello DLFeat&quot;</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span>
        <span class="n">img</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">path</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span> <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Pillow with ImageDraw not available to create dummy image for tests.&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span> <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not create dummy image: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">None</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_create_dummy_audio</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="s2">&quot;dummy_audio_dlfeat.wav&quot;</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">scipy_wav</span><span class="p">,</span> <span class="s1">&#39;write&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">scipy_wav</span><span class="o">.</span><span class="vm">__name__</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;dummy_&#39;</span><span class="p">):</span> <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s2">&quot;Scipy.io.wavfile not available or is a dummy.&quot;</span><span class="p">)</span>
        <span class="n">sample_rate</span> <span class="o">=</span> <span class="mi">16000</span><span class="p">;</span> <span class="n">duration</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">frequency</span> <span class="o">=</span> <span class="mi">440</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">duration</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">sample_rate</span> <span class="o">*</span> <span class="n">duration</span><span class="p">),</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">frequency</span> <span class="o">*</span> <span class="n">t</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span>
        <span class="n">data_int16</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span> <span class="o">*</span> <span class="mi">32767</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span>
        <span class="n">scipy_wav</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">sample_rate</span><span class="p">,</span> <span class="n">data_int16</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">path</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span> <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Scipy.io.wavfile not available to create dummy audio for tests.&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span> <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not create dummy audio: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">None</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_create_dummy_video</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">DUMMY_VIDEO_FILENAME</span><span class="p">,</span> <span class="n">download_real_video</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">download_real_video</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">requests</span><span class="p">,</span> <span class="s1">&#39;get&#39;</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">DUMMY_VIDEO_URL</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
            <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span> 
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">iter_content</span><span class="p">(</span><span class="n">chunk_size</span><span class="o">=</span><span class="mi">8192</span><span class="p">):</span> <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">path</span><span class="p">,</span> <span class="kc">True</span> 
        <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">RequestException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span> <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to download real sample video: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">. Using placeholder.&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span> <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;An error occurred during video download or saving: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">. Using placeholder.&quot;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span> <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;This is a placeholder for DLFeat video tests.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">path</span><span class="p">,</span> <span class="kc">False</span> 
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span> <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not create placeholder dummy video file: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">False</span>


<div class="viewcode-block" id="run_self_tests">
<a class="viewcode-back" href="../index.html#DLFeat.run_self_tests">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">run_self_tests</span><span class="p">(</span><span class="n">models_to_test</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="s1">&#39;cpu&#39;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">attempt_real_video_test</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> DLFeat Self-Test Suite (v</span><span class="si">{</span><span class="n">__version__</span><span class="si">}</span><span class="s2">)</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span><span class="p">)</span>
    <span class="n">actual_models_to_test</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">MODEL_CONFIGS</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">models_to_test</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">models_to_test</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="n">models_to_test</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">actual_models_to_test</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span> <span class="n">actual_models_to_test</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">MODEL_CONFIGS</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Running tests for: </span><span class="si">{</span><span class="n">actual_models_to_test</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">models_to_test</span><span class="o">==</span><span class="s1">&#39;all&#39;</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="n">models_to_test</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">dummy_image_path</span> <span class="o">=</span> <span class="n">_create_dummy_image</span><span class="p">();</span> <span class="n">dummy_audio_path</span> <span class="o">=</span> <span class="n">_create_dummy_audio</span><span class="p">()</span>
    <span class="n">dummy_video_file_path</span><span class="p">,</span> <span class="n">is_real_video</span> <span class="o">=</span> <span class="n">_create_dummy_video</span><span class="p">(</span><span class="n">download_real_video</span><span class="o">=</span><span class="n">attempt_real_video_test</span><span class="p">)</span>
    <span class="n">text_sample</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;This is a test sentence.&quot;</span><span class="p">,</span> <span class="s2">&quot;Another sentence for testing.&quot;</span><span class="p">]</span>
    <span class="n">test_results_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">model_name</span> <span class="ow">in</span> <span class="n">actual_models_to_test</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">model_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">MODEL_CONFIGS</span><span class="p">:</span>
            <span class="n">test_results_list</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;model_name&quot;</span><span class="p">:</span> <span class="n">model_name</span><span class="p">,</span> <span class="s2">&quot;task&quot;</span><span class="p">:</span> <span class="s2">&quot;N/A&quot;</span><span class="p">,</span> <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="s2">&quot;N/A&quot;</span><span class="p">,</span> <span class="s2">&quot;availability&quot;</span><span class="p">:</span> <span class="s2">&quot;✗&quot;</span><span class="p">,</span> <span class="s2">&quot;test_status&quot;</span><span class="p">:</span> <span class="s2">&quot;SKIPPED&quot;</span><span class="p">,</span> <span class="s2">&quot;notes&quot;</span><span class="p">:</span> <span class="s2">&quot;Not in MODEL_CONFIGS&quot;</span><span class="p">})</span>
            <span class="k">continue</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">MODEL_CONFIGS</span><span class="p">[</span><span class="n">model_name</span><span class="p">];</span> <span class="n">task</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;task&quot;</span><span class="p">];</span> <span class="n">source</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">]</span>
        <span class="n">current_result</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;model_name&quot;</span><span class="p">:</span> <span class="n">model_name</span><span class="p">,</span> <span class="s2">&quot;task&quot;</span><span class="p">:</span> <span class="n">task</span><span class="p">,</span> <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="n">source</span><span class="p">,</span> <span class="s2">&quot;availability&quot;</span><span class="p">:</span> <span class="s2">&quot;✗&quot;</span><span class="p">,</span> <span class="s2">&quot;test_status&quot;</span><span class="p">:</span> <span class="s2">&quot;SKIPPED&quot;</span><span class="p">,</span> <span class="s2">&quot;notes&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">}</span>
        <span class="n">notes_collector</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- Testing: </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2"> (Task: </span><span class="si">{</span><span class="n">task</span><span class="si">}</span><span class="s2">, Source: </span><span class="si">{</span><span class="n">source</span><span class="si">}</span><span class="s2">) ---&quot;</span><span class="p">)</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="n">extractor</span> <span class="o">=</span> <span class="n">DLFeatExtractor</span><span class="p">(</span><span class="n">model_name</span><span class="o">=</span><span class="n">model_name</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
            <span class="n">current_result</span><span class="p">[</span><span class="s2">&quot;availability&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;✓&quot;</span>
            <span class="n">dummy_input_data</span><span class="p">,</span> <span class="n">expected_batch_size</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">0</span>
            
            <span class="n">video_related_task</span> <span class="o">=</span> <span class="n">task</span> <span class="o">==</span> <span class="s2">&quot;video&quot;</span> <span class="ow">or</span> <span class="n">task</span> <span class="o">==</span> <span class="s2">&quot;multimodal_video_text&quot;</span>
            <span class="n">skip_video_transform</span> <span class="o">=</span> <span class="n">video_related_task</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="p">(</span><span class="n">dummy_video_file_path</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dummy_video_file_path</span><span class="p">))</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">is_real_video</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">video_related_task</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="n">dummy_video_file_path</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dummy_video_file_path</span><span class="p">)):</span> <span class="n">notes_collector</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;No dummy video file.&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">video_related_task</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_real_video</span><span class="p">:</span> <span class="n">notes_collector</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Using placeholder video.&quot;</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">task</span> <span class="o">==</span> <span class="s2">&quot;image&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">dummy_image_path</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dummy_image_path</span><span class="p">):</span> <span class="n">dummy_input_data</span><span class="p">,</span> <span class="n">expected_batch_size</span> <span class="o">=</span> <span class="p">[</span><span class="n">dummy_image_path</span><span class="p">]</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span>
                <span class="k">else</span><span class="p">:</span> <span class="n">notes_collector</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;No dummy image.&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">task</span> <span class="o">==</span> <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">dummy_input_data</span><span class="p">,</span> <span class="n">expected_batch_size</span> <span class="o">=</span> <span class="n">text_sample</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">text_sample</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">task</span> <span class="o">==</span> <span class="s2">&quot;audio&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">dummy_audio_path</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dummy_audio_path</span><span class="p">):</span> <span class="n">dummy_input_data</span><span class="p">,</span> <span class="n">expected_batch_size</span> <span class="o">=</span> <span class="p">[</span><span class="n">dummy_audio_path</span><span class="p">]</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span>
                <span class="k">else</span><span class="p">:</span> <span class="n">notes_collector</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;No dummy audio.&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">task</span> <span class="o">==</span> <span class="s2">&quot;video&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">skip_video_transform</span><span class="p">:</span> <span class="n">dummy_input_data</span><span class="p">,</span> <span class="n">expected_batch_size</span> <span class="o">=</span> <span class="p">[</span><span class="n">dummy_video_file_path</span><span class="p">]</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span>
            <span class="k">elif</span> <span class="n">task</span> <span class="o">==</span> <span class="s2">&quot;multimodal_image_text&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">dummy_image_path</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dummy_image_path</span><span class="p">):</span> <span class="n">dummy_input_data</span><span class="p">,</span> <span class="n">expected_batch_size</span> <span class="o">=</span> <span class="p">[(</span><span class="n">dummy_image_path</span><span class="p">,</span> <span class="n">text_sample</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="p">(</span><span class="n">dummy_image_path</span><span class="p">,</span> <span class="n">text_sample</span><span class="p">[</span><span class="mi">1</span><span class="p">])],</span> <span class="mi">2</span>
                <span class="k">else</span><span class="p">:</span> <span class="n">notes_collector</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;No dummy image for multimodal.&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">task</span> <span class="o">==</span> <span class="s2">&quot;multimodal_video_text&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">skip_video_transform</span><span class="p">:</span> <span class="n">dummy_input_data</span><span class="p">,</span> <span class="n">expected_batch_size</span> <span class="o">=</span> <span class="p">[(</span><span class="n">dummy_video_file_path</span><span class="p">,</span> <span class="n">text_sample</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="p">(</span><span class="n">dummy_video_file_path</span><span class="p">,</span> <span class="n">text_sample</span><span class="p">[</span><span class="mi">1</span><span class="p">])],</span> <span class="mi">2</span>

            <span class="k">if</span> <span class="n">skip_video_transform</span> <span class="ow">and</span> <span class="n">current_result</span><span class="p">[</span><span class="s2">&quot;availability&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;✓&quot;</span><span class="p">:</span>
                <span class="n">current_result</span><span class="p">[</span><span class="s2">&quot;test_status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;SKIPPED (Transform)&quot;</span>
            <span class="k">elif</span> <span class="n">dummy_input_data</span><span class="p">:</span>
                <span class="n">features</span> <span class="o">=</span> <span class="n">extractor</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">dummy_input_data</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;multimodal&quot;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span> <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Multimodal features not dict (got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">features</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
                    <span class="n">key_map</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;multimodal_image_text&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;image_features&quot;</span><span class="p">,</span> <span class="s2">&quot;text_features&quot;</span><span class="p">],</span> <span class="s2">&quot;multimodal_video_text&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;video_features&quot;</span><span class="p">,</span> <span class="s2">&quot;text_features&quot;</span><span class="p">]}</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">k</span> <span class="ow">in</span> <span class="n">features</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">key_map</span><span class="p">[</span><span class="n">task</span><span class="p">]):</span> <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Missing keys in multimodal output. Expected </span><span class="si">{</span><span class="n">key_map</span><span class="p">[</span><span class="n">task</span><span class="p">]</span><span class="si">}</span><span class="s2">, Got </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">features</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">key_feat</span><span class="p">,</span> <span class="n">val_feat</span> <span class="ow">in</span> <span class="n">features</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val_feat</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span> <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Feature &#39;</span><span class="si">{</span><span class="n">key_feat</span><span class="si">}</span><span class="s2">&#39; not np.ndarray.&quot;</span><span class="p">)</span>
                        <span class="n">expected_dim_mm</span> <span class="o">=</span> <span class="n">extractor</span><span class="o">.</span><span class="n">get_feature_dimension</span><span class="p">()</span> 
                        <span class="k">if</span> <span class="n">val_feat</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="p">(</span><span class="n">expected_batch_size</span><span class="p">,</span> <span class="n">expected_dim_mm</span><span class="p">):</span> <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Feature &#39;</span><span class="si">{</span><span class="n">key_feat</span><span class="si">}</span><span class="s2">&#39; shape mismatch. Got </span><span class="si">{</span><span class="n">val_feat</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">, expected (</span><span class="si">{</span><span class="n">expected_batch_size</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">expected_dim_mm</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span> <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Features not np.ndarray (got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">features</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
                    <span class="n">expected_dim_uni</span> <span class="o">=</span> <span class="n">extractor</span><span class="o">.</span><span class="n">get_feature_dimension</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">features</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="p">(</span><span class="n">expected_batch_size</span><span class="p">,</span> <span class="n">expected_dim_uni</span><span class="p">):</span> <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Feature shape mismatch. Got </span><span class="si">{</span><span class="n">features</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">, expected (</span><span class="si">{</span><span class="n">expected_batch_size</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">expected_dim_uni</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
                <span class="n">current_result</span><span class="p">[</span><span class="s2">&quot;test_status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;PASSED&quot;</span>
            <span class="k">else</span><span class="p">:</span> <span class="n">current_result</span><span class="p">[</span><span class="s2">&quot;test_status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;SKIPPED (No data)&quot;</span>
        <span class="k">except</span> <span class="ne">ImportError</span> <span class="k">as</span> <span class="n">ie</span><span class="p">:</span> 
            <span class="n">current_result</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;availability&quot;</span><span class="p">:</span> <span class="s2">&quot;✗ (Import)&quot;</span><span class="p">,</span> <span class="s2">&quot;test_status&quot;</span><span class="p">:</span> <span class="s2">&quot;FAILED&quot;</span><span class="p">})</span>
            <span class="n">notes_collector</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">ie</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">textwrap</span><span class="o">.</span><span class="n">shorten</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">ie</span><span class="p">)</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span><span class="mi">60</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">] FAILED (Initialization ImportError):</span><span class="se">\n</span><span class="si">{</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span> 
            <span class="n">current_result</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;test_status&quot;</span><span class="p">:</span> <span class="s2">&quot;FAILED (Runtime)&quot;</span> <span class="k">if</span> <span class="n">current_result</span><span class="p">[</span><span class="s2">&quot;availability&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;✓&quot;</span> <span class="k">else</span> <span class="s2">&quot;FAILED (Init)&quot;</span><span class="p">})</span>
            <span class="n">notes_collector</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">textwrap</span><span class="o">.</span><span class="n">shorten</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span><span class="mi">60</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">] FAILED (</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">):</span><span class="se">\n</span><span class="si">{</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="n">current_result</span><span class="p">[</span><span class="s2">&quot;notes&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">notes_collector</span><span class="p">)</span> <span class="k">if</span> <span class="n">notes_collector</span> <span class="k">else</span> <span class="n">current_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;notes&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="c1"># Preserve existing notes from exceptions</span>
        <span class="n">test_results_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">current_result</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">dummy_image_path</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dummy_image_path</span><span class="p">):</span> <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">dummy_image_path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">dummy_audio_path</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dummy_audio_path</span><span class="p">):</span> <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">dummy_audio_path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">dummy_video_file_path</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dummy_video_file_path</span><span class="p">):</span> <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">dummy_video_file_path</span><span class="p">)</span> 
    
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">80</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> DLFeat Self-Test Summary Report&quot;</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="mi">80</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">80</span><span class="p">)</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Model&quot;</span><span class="p">:</span> <span class="mi">30</span><span class="p">,</span> <span class="s2">&quot;Task&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span> <span class="s2">&quot;Source&quot;</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span> <span class="s2">&quot;Available&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="s2">&quot;Test Status&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span> <span class="s2">&quot;Notes&quot;</span><span class="p">:</span> <span class="mi">40</span><span class="p">}</span>
    <span class="n">header</span> <span class="o">=</span> <span class="s2">&quot;| &quot;</span> <span class="o">+</span> <span class="s2">&quot; | &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">col_name</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">cols</span><span class="p">[</span><span class="n">col_name</span><span class="p">])</span> <span class="k">for</span> <span class="n">col_name</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot; |&quot;</span>
    <span class="n">separator</span> <span class="o">=</span> <span class="s2">&quot;|&quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s2">&quot;-&quot;</span><span class="o">*</span><span class="p">(</span><span class="n">cols</span><span class="p">[</span><span class="n">col_name</span><span class="p">]</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;|&quot;</span> <span class="k">for</span> <span class="n">col_name</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">])</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">separator</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">header</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">separator</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">test_results_list</span><span class="p">:</span>
        <span class="n">row</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;| </span><span class="si">{</span><span class="n">textwrap</span><span class="o">.</span><span class="n">shorten</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;model_name&#39;</span><span class="p">],</span><span class="w"> </span><span class="n">width</span><span class="o">=</span><span class="n">cols</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">cols</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2"> &quot;</span> \
              <span class="sa">f</span><span class="s2">&quot;| </span><span class="si">{</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;task&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">cols</span><span class="p">[</span><span class="s1">&#39;Task&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2"> &quot;</span> \
              <span class="sa">f</span><span class="s2">&quot;| </span><span class="si">{</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">cols</span><span class="p">[</span><span class="s1">&#39;Source&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2"> &quot;</span> \
              <span class="sa">f</span><span class="s2">&quot;| </span><span class="si">{</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;availability&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="n">cols</span><span class="p">[</span><span class="s1">&#39;Available&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2"> &quot;</span> \
              <span class="sa">f</span><span class="s2">&quot;| </span><span class="si">{</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;test_status&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">cols</span><span class="p">[</span><span class="s1">&#39;Test Status&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2"> &quot;</span> \
              <span class="sa">f</span><span class="s2">&quot;| </span><span class="si">{</span><span class="n">textwrap</span><span class="o">.</span><span class="n">shorten</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;notes&#39;</span><span class="p">],</span><span class="w"> </span><span class="n">width</span><span class="o">=</span><span class="n">cols</span><span class="p">[</span><span class="s1">&#39;Notes&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">cols</span><span class="p">[</span><span class="s1">&#39;Notes&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2"> |&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">separator</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">80</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">test_results_list</span></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">run_self_tests</span><span class="p">(</span><span class="n">attempt_real_video_test</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> 
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Your Name/Gemini.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>